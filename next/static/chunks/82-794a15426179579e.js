"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[82],{82:(e,t,r)=>{r.d(t,{A:()=>x});var a=r(5155),i=r(6766),o=r(2115),n=r(4105),s=r(8564),l=r(7809),c=r(7712),d=r(4616),u=r(5203),m=r(7652),g=r(5695),p=r(6874),f=r.n(p),h=r(3999),y=r(668);let w=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;return e.length<=t?e:e.substring(0,t-3)+"..."},x=(0,o.memo)(function(e){let{product:t,pageName:r}=e,p=(0,m.c3)(""),x=(0,g.usePathname)().split("/")[1]||"ar",{userId:_}=(0,y.A)(),b=(0,u.useCartStore)(e=>e.items.find(e=>e.product_id===t.id)),v=(0,u.useCartStore)(e=>e.addItem),S=(0,u.useCartStore)(e=>e.updateQuantity),k=(0,u.useCartStore)(e=>e.isLoading),j=(null==b?void 0:b.quantity)||0,N=t.availability?t.sold_quantity&&t.sold_quantity>10?p("products.topSellingLabel"):null:p("products.outOfStockLabel"),I=w("ar"===x?t.description_ar:t.description_en,100),C=(0,o.useCallback)(async e=>{e.preventDefault(),e.stopPropagation();try{await v({product_id:t.id,name_en:t.name_en,name_ar:t.name_ar,description_en:t.description_en,description_ar:t.description_ar,price:t.price,image:t.image[0]},_,x)}catch(e){console.error("Error adding to cart:",e)}},[v,t,_,x,t.image]),q=(0,o.useCallback)(async(e,r)=>{e.preventDefault(),e.stopPropagation();try{await S(t.id,r,_,x)}catch(e){console.error("Error updating quantity:",e)}},[S,t.id,_,x]);return(0,a.jsx)(f(),{href:"/".concat(x,"/products/").concat(t.id),passHref:!0,children:(0,a.jsxs)(n.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.2,ease:"easeOut"},whileHover:{scale:1.03,boxShadow:"0 10px 25px rgba(0, 0, 0, 0.1)"},className:"products"!==r?"bg-[#337a5b] rounded-xl p-4 text-white flex flex-col justify-between h-full w-full relative cursor-pointer":"bg-[#337a5b] rounded-xl p-4 text-white flex flex-col justify-between h-full relative cursor-pointer w-[280px]","aria-label":"ar"===x?t.name_ar:t.name_en,children:[(0,a.jsxs)("div",{className:"mb-4 flex justify-center items-center rounded-lg h-[270px] w-full relative",children:[N&&(0,a.jsx)("span",{className:"absolute top-2 right-2 px-2 py-1 text-xs font-medium text-white bg-[#025162] rounded-md",children:N}),(0,a.jsx)(i.default,{src:"http://127.0.0.1:8000"+t.image[0],alt:"ar"===x?t.name_ar:t.name_en,width:300,height:270,className:"object-cover rounded-lg w-full h-full"})]}),(0,a.jsxs)("div",{className:"flex flex-col flex-grow",children:[(0,a.jsx)("h3",{className:"font-medium text-center mb-1 text-white",children:"ar"===x?t.name_ar:t.name_en}),(0,a.jsx)("p",{className:"text-xs text-center mb-2 flex-grow text-white overflow-hidden overflow-ellipsis whitespace-nowrap",children:I}),(0,a.jsx)("div",{className:"flex justify-center mb-2",children:Array.from({length:5}).map((e,r)=>(0,a.jsx)(s.A,{className:"h-4 w-4 ".concat(r<Math.floor(t.rating||0)?"text-yellow-400 fill-yellow-400":"text-[#e5e5e5]")},r))}),(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[t.price?(0,a.jsx)("span",{className:"font-medium text-white",children:(0,h.$)(parseFloat(t.price),x)}):(0,a.jsx)("span",{className:"font-medium text-white",children:p("products.contactForPrice")}),0===j?(0,a.jsx)("button",{onClick:C,disabled:k||!t.availability,className:"h-8 w-8 flex items-center justify-center rounded-md transition-colors bg-white text-[#337a5b] hover:bg-gray-200 ".concat(k||!t.availability?"cursor-not-allowed":""),"aria-label":p("products.addToCart"),children:(0,a.jsx)(l.A,{className:"h-4 w-4"})}):(0,a.jsxs)("div",{className:"flex items-center rounded-md overflow-hidden border border-white",role:"group","aria-label":p("products.quantityControl"),children:[(0,a.jsx)("button",{onClick:e=>q(e,j-1),disabled:k,className:"h-8 w-8 flex items-center justify-center transition-colors bg-white text-[#337a5b] hover:bg-gray-200 ".concat(k?"cursor-wait":""),"aria-label":p("products.decreaseQuantity"),children:(0,a.jsx)(c.A,{className:"h-4 w-4"})}),(0,a.jsx)("span",{className:"h-8 w-8 flex items-center justify-center bg-[#337a5b] text-white","aria-live":"polite",children:j}),(0,a.jsx)("button",{onClick:e=>q(e,j+1),disabled:k||!t.availability,className:"h-8 w-8 flex items-center justify-center transition-colors bg-white text-[#337a5b] hover:bg-gray-200 ".concat(k||!t.availability?"cursor-not-allowed":""),"aria-label":p("products.increaseQuantity"),children:(0,a.jsx)(d.A,{className:"h-4 w-4"})})]})]})]})]})})})},668:(e,t,r)=>{r.d(t,{A:()=>d,AuthProvider:()=>c});var a=r(5155),i=r(2115),o=r(5695),n=r(6720),s=r(5203);let l=(0,i.createContext)(void 0),c=e=>{let{children:t}=e,[c,d]=(0,i.useState)(!1),[u,m]=(0,i.useState)(null),g=(0,o.useRouter)(),p=(0,o.usePathname)().split("/")[1]||"en";(0,i.useEffect)(()=>{let e=localStorage.getItem("token"),t=localStorage.getItem("userId"),a=localStorage.getItem("tokenTimestamp");e&&t&&a&&(Date.now()-parseInt(a,10)>864e5?h():(d(!0),m(t),Promise.resolve().then(r.bind(r,5203)).then(e=>{let{useCartStore:r}=e;r.getState().syncWithBackend(t,p)}).catch(e=>{console.error("Error syncing cart on initial load:",e)})))},[p]);let f=async(e,t)=>{localStorage.setItem("token",e),localStorage.setItem("userId",t),localStorage.setItem("tokenTimestamp",Date.now().toString()),d(!0),m(t);try{await Promise.resolve().then(r.bind(r,5203)).then(e=>{let{useCartStore:r}=e;return r.getState().syncWithBackend(t,p)})}catch(e){console.error("Error syncing cart after login:",e)}},h=async()=>{try{let e=localStorage.getItem("token");if(!e)throw Error("No token found in localStorage for logout.");await (0,n.PZ)(e),console.log("Logout successful")}catch(e){console.error("Logout failed:",e)}localStorage.removeItem("token"),localStorage.removeItem("userId"),localStorage.removeItem("tokenTimestamp"),d(!1),m(null),s.useCartStore.getState().logout(),g.push("/".concat(p,"/login"))};return(0,a.jsx)(l.Provider,{value:{isAuthenticated:c,userId:u,login:f,logout:h},children:t})},d=()=>{let e=(0,i.useContext)(l);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},3999:(e,t,r)=>{function a(e,t){let r="string"==typeof e?parseFloat(e):e;if(isNaN(r))return"ar"===t?"غير متوفر":"Not available";let a=new Intl.NumberFormat("ar"===t?"ar-JO":"en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return"".concat(a.format(r)," ").concat("ar"===t?"د.أ":"JD")}function i(e,t,r){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10;if(!e||!e.categories||0===e.categories.length)return t.filter(t=>t.id!==(null==e?void 0:e.id)).sort(()=>Math.random()-.5).slice(0,a);let i=e.categories.filter(e=>null===e.parent_id).map(e=>e.id),o=e.categories.filter(e=>null!==e.parent_id).map(e=>e.id),n=new Set;for(let e of o)for(let t of r)t.subcategories.some(t=>t.id===e)&&n.add(t.id);let s=[...t.filter(t=>{if(t.id===e.id)return!1;let a=t.categories.map(e=>e.id);if(a.some(e=>a.includes(e))||a.some(e=>n.has(e)))return!0;for(let e of i)for(let t of r)if(t.id===e&&a.some(e=>t.subcategories.some(t=>t.id===e)))return!0;return!1})];if(s.length<a){let r=new Set(s.map(e=>e.id).concat(e.id)),i=t.filter(e=>!r.has(e.id)).sort(()=>Math.random()-.5);s.push(...i.slice(0,a-s.length))}return s.sort(()=>Math.random()-.5).slice(0,a)}r.d(t,{$:()=>a,S:()=>i})},5203:(e,t,r)=>{r.r(t),r.d(t,{useCartStore:()=>s});var a=r(5453),i=r(6786),o=r(6720);let n=e=>e instanceof Error?e.message.includes("customer_id")||e.message.includes("The selected")?"Invalid user ID. Please log in again or contact support.":e.message.includes("POST method is not supported")?"Cart sync failed due to server configuration. Please try again later.":e.message||"Operation failed. Please try again.":"Operation failed.",s=(0,a.v)()((0,i.eh)((0,i.Zr)((e,t)=>({items:[],isLoading:!1,error:null,addItem:async(r,a,i)=>{e({isLoading:!0,error:null});let s=t().items;try{let n=s.find(e=>e.product_id===r.product_id),l=n?n.quantity+1:1,c={...r,id:(null==n?void 0:n.id)||Date.now(),customer_id:a||"guest",quantity:l};n?e({items:s.map(e=>e.product_id===r.product_id?c:e)}):e({items:[...s,c]}),a&&(await (0,o.V2)({customer_id:a,product_id:r.product_id,quantity:l},i),await t().syncWithBackend(a,i))}catch(t){console.error("Error adding item to cart:",t),e({items:s,error:n(t)})}finally{e({isLoading:!1})}},removeItem:async(r,a,i)=>{e({isLoading:!0,error:null});let s=t().items;try{let n=s.find(e=>e.product_id===r);if(!n)return;e({items:s.filter(e=>e.product_id!==r)}),a&&(await (0,o.V2)({customer_id:a,product_id:n.product_id,quantity:0},i),await t().syncWithBackend(a,i))}catch(t){console.error("Error removing item from cart:",t),e({items:s,error:n(t)})}finally{e({isLoading:!1})}},updateQuantity:async(r,a,i,s)=>{e({isLoading:!0,error:null});let l=t().items;try{let n=l.find(e=>e.product_id===r);if(!n)return;a<=0?e({items:l.filter(e=>e.product_id!==r)}):e({items:l.map(e=>e.product_id===r?{...e,quantity:a}:e)}),i&&(await (0,o.V2)({customer_id:i,product_id:n.product_id,quantity:a},s),await t().syncWithBackend(i,s))}catch(t){console.error("Error updating cart item quantity:",t),e({items:l,error:n(t)})}finally{e({isLoading:!1})}},clearCart:async(r,a)=>{e({isLoading:!0,error:null});let i=t().items,s=localStorage.getItem("token");try{e({items:[]}),r&&await (0,o.sX)(r,a,s),await t().syncWithBackend(r,a)}catch(t){console.error("Error clearing cart:",t),e({items:i,error:n(t)})}finally{e({isLoading:!1})}},syncWithBackend:async(r,a)=>{if(!r){console.warn("No user authenticated or server-side, skipping cart sync");return}if(!localStorage.getItem("token")){console.warn("No token found, skipping cart sync");return}e({isLoading:!0,error:null});try{let i=(await (0,o.Fy)(r,a)).map(e=>({id:e.id,product_id:e.product_id,customer_id:e.customer_id,name_en:e.name_en,name_ar:e.name_ar,description_en:e.description_en,description_ar:e.description_ar,price:e.price,image:e.image,quantity:e.quantity})),n=t().items.filter(e=>"guest"===e.customer_id||e.customer_id===r),s=[];for(let e of i)s.push(e);for(let e of n)s.some(t=>t.product_id===e.product_id)||s.push({...e,customer_id:r});for(let t of(e({items:s,error:null}),s))await (0,o.V2)({customer_id:r,product_id:t.product_id,quantity:t.quantity},a)}catch(t){console.error("Error syncing with backend:",t),e({error:n(t)})}finally{e({isLoading:!1})}},logout:()=>{e({items:[],error:null}),console.log("Cart cleared on logout")},total:()=>t().items.reduce((e,t)=>e+(parseFloat(t.price)||0)*t.quantity,0),totalItems:()=>t().items.reduce((e,t)=>e+t.quantity,0)}),{name:"cart-storage",partialize:e=>({items:e.items})})));(async()=>{let e=localStorage.getItem("token"),t=localStorage.getItem("userId");if(e&&t)try{let e=localStorage.getItem("locale")||"ar";await s.getState().syncWithBackend(t,e)}catch(e){console.error("Initial cart load error:",e)}})()}}]);