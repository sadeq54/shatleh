(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5495],{668:(e,t,r)=>{"use strict";r.d(t,{A:()=>d,AuthProvider:()=>c});var a=r(5155),o=r(2115),i=r(5695),n=r(6720),s=r(5203);let l=(0,o.createContext)(void 0),c=e=>{let{children:t}=e,[c,d]=(0,o.useState)(!1),[u,m]=(0,o.useState)(null),g=(0,i.useRouter)(),f=(0,i.usePathname)().split("/")[1]||"en";(0,o.useEffect)(()=>{let e=localStorage.getItem("token"),t=localStorage.getItem("userId"),a=localStorage.getItem("tokenTimestamp");e&&t&&a&&(Date.now()-parseInt(a,10)>864e5?p():(d(!0),m(t),Promise.resolve().then(r.bind(r,5203)).then(e=>{let{useCartStore:r}=e;r.getState().syncWithBackend(t,f)}).catch(e=>{console.error("Error syncing cart on initial load:",e)})))},[f]);let h=async(e,t)=>{localStorage.setItem("token",e),localStorage.setItem("userId",t),localStorage.setItem("tokenTimestamp",Date.now().toString()),d(!0),m(t);try{await Promise.resolve().then(r.bind(r,5203)).then(e=>{let{useCartStore:r}=e;return r.getState().syncWithBackend(t,f)})}catch(e){console.error("Error syncing cart after login:",e)}},p=async()=>{try{let e=localStorage.getItem("token");if(!e)throw Error("No token found in localStorage for logout.");await (0,n.PZ)(e),console.log("Logout successful")}catch(e){console.error("Logout failed:",e)}localStorage.removeItem("token"),localStorage.removeItem("userId"),localStorage.removeItem("tokenTimestamp"),d(!1),m(null),s.useCartStore.getState().logout(),g.push("/".concat(f,"/login"))};return(0,a.jsx)(l.Provider,{value:{isAuthenticated:c,userId:u,login:h,logout:p},children:t})},d=()=>{let e=(0,o.useContext)(l);if(!e)throw Error("useAuth must be used within an AuthProvider");return e}},726:(e,t,r)=>{Promise.resolve().then(r.bind(r,9573))},5203:(e,t,r)=>{"use strict";r.r(t),r.d(t,{useCartStore:()=>s});var a=r(5453),o=r(6786),i=r(6720);let n=e=>e instanceof Error?e.message.includes("customer_id")||e.message.includes("The selected")?"Invalid user ID. Please log in again or contact support.":e.message.includes("POST method is not supported")?"Cart sync failed due to server configuration. Please try again later.":e.message||"Operation failed. Please try again.":"Operation failed.",s=(0,a.v)()((0,o.eh)((0,o.Zr)((e,t)=>({items:[],isLoading:!1,error:null,addItem:async(r,a,o)=>{e({isLoading:!0,error:null});let s=t().items;try{let n=s.find(e=>e.product_id===r.product_id),l=n?n.quantity+1:1,c={...r,id:(null==n?void 0:n.id)||Date.now(),customer_id:a||"guest",quantity:l};n?e({items:s.map(e=>e.product_id===r.product_id?c:e)}):e({items:[...s,c]}),a&&(await (0,i.V2)({customer_id:a,product_id:r.product_id,quantity:l},o),await t().syncWithBackend(a,o))}catch(t){console.error("Error adding item to cart:",t),e({items:s,error:n(t)})}finally{e({isLoading:!1})}},removeItem:async(r,a,o)=>{e({isLoading:!0,error:null});let s=t().items;try{let n=s.find(e=>e.product_id===r);if(!n)return;e({items:s.filter(e=>e.product_id!==r)}),a&&(await (0,i.V2)({customer_id:a,product_id:n.product_id,quantity:0},o),await t().syncWithBackend(a,o))}catch(t){console.error("Error removing item from cart:",t),e({items:s,error:n(t)})}finally{e({isLoading:!1})}},updateQuantity:async(r,a,o,s)=>{e({isLoading:!0,error:null});let l=t().items;try{let n=l.find(e=>e.product_id===r);if(!n)return;a<=0?e({items:l.filter(e=>e.product_id!==r)}):e({items:l.map(e=>e.product_id===r?{...e,quantity:a}:e)}),o&&(await (0,i.V2)({customer_id:o,product_id:n.product_id,quantity:a},s),await t().syncWithBackend(o,s))}catch(t){console.error("Error updating cart item quantity:",t),e({items:l,error:n(t)})}finally{e({isLoading:!1})}},clearCart:async(r,a)=>{e({isLoading:!0,error:null});let o=t().items,s=localStorage.getItem("token");try{e({items:[]}),r&&await (0,i.sX)(r,a,s),await t().syncWithBackend(r,a)}catch(t){console.error("Error clearing cart:",t),e({items:o,error:n(t)})}finally{e({isLoading:!1})}},syncWithBackend:async(r,a)=>{if(!r){console.warn("No user authenticated or server-side, skipping cart sync");return}if(!localStorage.getItem("token")){console.warn("No token found, skipping cart sync");return}e({isLoading:!0,error:null});try{let o=(await (0,i.Fy)(r,a)).map(e=>({id:e.id,product_id:e.product_id,customer_id:e.customer_id,name_en:e.name_en,name_ar:e.name_ar,description_en:e.description_en,description_ar:e.description_ar,price:e.price,image:e.image,quantity:e.quantity})),n=t().items.filter(e=>"guest"===e.customer_id||e.customer_id===r),s=[];for(let e of o)s.push(e);for(let e of n)s.some(t=>t.product_id===e.product_id)||s.push({...e,customer_id:r});for(let t of(e({items:s,error:null}),s))await (0,i.V2)({customer_id:r,product_id:t.product_id,quantity:t.quantity},a)}catch(t){console.error("Error syncing with backend:",t),e({error:n(t)})}finally{e({isLoading:!1})}},logout:()=>{e({items:[],error:null}),console.log("Cart cleared on logout")},total:()=>t().items.reduce((e,t)=>e+(parseFloat(t.price)||0)*t.quantity,0),totalItems:()=>t().items.reduce((e,t)=>e+t.quantity,0)}),{name:"cart-storage",partialize:e=>({items:e.items})})));(async()=>{let e=localStorage.getItem("token"),t=localStorage.getItem("userId");if(e&&t)try{let e=localStorage.getItem("locale")||"ar";await s.getState().syncWithBackend(t,e)}catch(e){console.error("Initial cart load error:",e)}})()},5453:(e,t,r)=>{"use strict";r.d(t,{v:()=>l});var a=r(2115);let o=e=>{let t;let r=new Set,a=(e,a)=>{let o="function"==typeof e?e(t):e;if(!Object.is(o,t)){let e=t;t=(null!=a?a:"object"!=typeof o||null===o)?o:Object.assign({},t,o),r.forEach(r=>r(t,e))}},o=()=>t,i={setState:a,getState:o,getInitialState:()=>n,subscribe:e=>(r.add(e),()=>r.delete(e))},n=t=e(a,o,i);return i},i=e=>e?o(e):o,n=e=>e,s=e=>{let t=i(e),r=e=>(function(e,t=n){let r=a.useSyncExternalStore(e.subscribe,()=>t(e.getState()),()=>t(e.getInitialState()));return a.useDebugValue(r),r})(t,e);return Object.assign(r,t),r},l=e=>e?s(e):s},6786:(e,t,r)=>{"use strict";r.d(t,{Zr:()=>i,eh:()=>a});let a=e=>(t,r,a)=>{let o=a.subscribe;return a.subscribe=(e,t,r)=>{let i=e;if(t){let o=(null==r?void 0:r.equalityFn)||Object.is,n=e(a.getState());i=r=>{let a=e(r);if(!o(n,a)){let e=n;t(n=a,e)}},(null==r?void 0:r.fireImmediately)&&t(n,n)}return o(i)},e(t,r,a)},o=e=>t=>{try{let r=e(t);if(r instanceof Promise)return r;return{then:e=>o(e)(r),catch(e){return this}}}catch(e){return{then(e){return this},catch:t=>o(t)(e)}}},i=(e,t)=>(r,a,i)=>{let n,s={storage:function(e,t){let r;try{r=e()}catch(e){return}return{getItem:e=>{var t;let a=e=>null===e?null:JSON.parse(e,void 0),o=null!=(t=r.getItem(e))?t:null;return o instanceof Promise?o.then(a):a(o)},setItem:(e,t)=>r.setItem(e,JSON.stringify(t,void 0)),removeItem:e=>r.removeItem(e)}}(()=>localStorage),partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...t},l=!1,c=new Set,d=new Set,u=s.storage;if(!u)return e((...e)=>{console.warn(`[zustand persist middleware] Unable to update item '${s.name}', the given storage is currently unavailable.`),r(...e)},a,i);let m=()=>{let e=s.partialize({...a()});return u.setItem(s.name,{state:e,version:s.version})},g=i.setState;i.setState=(e,t)=>{g(e,t),m()};let f=e((...e)=>{r(...e),m()},a,i);i.getInitialState=()=>f;let h=()=>{var e,t;if(!u)return;l=!1,c.forEach(e=>{var t;return e(null!=(t=a())?t:f)});let i=(null==(t=s.onRehydrateStorage)?void 0:t.call(s,null!=(e=a())?e:f))||void 0;return o(u.getItem.bind(u))(s.name).then(e=>{if(e){if("number"!=typeof e.version||e.version===s.version)return[!1,e.state];if(s.migrate){let t=s.migrate(e.state,e.version);return t instanceof Promise?t.then(e=>[!0,e]):[!0,t]}console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}return[!1,void 0]}).then(e=>{var t;let[o,i]=e;if(r(n=s.merge(i,null!=(t=a())?t:f),!0),o)return m()}).then(()=>{null==i||i(n,void 0),n=a(),l=!0,d.forEach(e=>e(n))}).catch(e=>{null==i||i(void 0,e)})};return i.persist={setOptions:e=>{s={...s,...e},e.storage&&(u=e.storage)},clearStorage:()=>{null==u||u.removeItem(s.name)},getOptions:()=>s,rehydrate:()=>h(),hasHydrated:()=>l,onHydrate:e=>(c.add(e),()=>{c.delete(e)}),onFinishHydration:e=>(d.add(e),()=>{d.delete(e)})},s.skipHydration||h(),n||f}},9573:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>u});var a=r(5155),o=r(2115),i=r(7652),n=r(5695),s=r(6874),l=r.n(s),c=r(668),d=r(6720);function u(){let e=(0,i.c3)("login"),t=(0,n.usePathname)(),r=(0,n.useRouter)(),s=(0,n.useSearchParams)(),{login:u,isAuthenticated:m}=(0,c.A)(),g=t.split("/")[1]||"ar",f=s.get("redirect")||"/",[h,p]=(0,o.useState)(""),[y,v]=(0,o.useState)(""),[b,x]=(0,o.useState)(""),[w,S]=(0,o.useState)(!1);(0,o.useEffect)(()=>{m&&r.push("/".concat(g).concat(f))},[m,r,g,f]);let _=async t=>{t.preventDefault(),x(""),S(!0);try{let{token:t,user:a}=await (0,d.iD)({email:h,password:y,language:g});if(!t||!(null==a?void 0:a.id))throw Error(e("loginFailed"));await u(t,a.id),r.push("/".concat(g).concat(f))}catch(r){console.error("Login error:",r);let t=r instanceof Error?r:Error(e("loginFailed"));x(t.message.includes("Network Error")?e("corsError"):t.message||e("loginFailed"))}finally{S(!1)}};return(0,a.jsx)("main",{className:"flex-grow mx-auto px-4 py-10 flex justify-center max-w-7xl mb-40",children:(0,a.jsx)("div",{className:"w-full max-w-md rounded-3xl border-2 border-[#94f198] p-8 shadow-lg relative overflow-hidden",children:(0,a.jsxs)("div",{className:"relative z-10 mx-auto mb-4",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-center mb-1",children:e("title")}),(0,a.jsx)("div",{className:"w-24 h-1 bg-[#94f198] mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-center text-gray-600 mb-8",children:e("welcome")}),b&&(0,a.jsx)("p",{className:"text-red-500 text-center mb-4",children:b}),(0,a.jsxs)("form",{onSubmit:_,className:"space-y-4",children:[(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("label",{htmlFor:"email",className:"block text-gray-700 mb-2",children:e("email")}),(0,a.jsx)("input",{type:"email",id:"email",placeholder:e("email"),value:h,onChange:e=>p(e.target.value),className:"w-full px-4 py-3 rounded-md bg-gradient-to-tl from-[#c1ebc3] to-[#94f198] border-none focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#94f198]",required:!0})]}),(0,a.jsxs)("div",{className:"mb-2",children:[(0,a.jsx)("label",{htmlFor:"password",className:"block text-gray-700 mb-2",children:e("password")}),(0,a.jsx)("input",{type:"password",id:"password",placeholder:e("password"),value:y,onChange:e=>v(e.target.value),className:"w-full px-4 py-3 rounded-md bg-gradient-to-tl from-[#c1ebc3] to-[#94f198] border-none focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[#94f198]",required:!0})]}),(0,a.jsx)("div",{className:"text-right mb-6",children:(0,a.jsx)(l(),{href:"/".concat(g,"/forgot-password"),className:"text-sm text-gray-600 hover:text-[#539407]",children:e("forgotPassword")})}),(0,a.jsx)("button",{type:"submit",disabled:w,className:"w-full bg-[#94f198] hover:bg-[#7ad97e] text-black py-3 rounded-md font-medium uppercase transition-colors disabled:bg-gray-400",children:w?e("loading"):e("login")}),(0,a.jsx)("div",{className:"text-center mt-6",children:(0,a.jsxs)("p",{className:"text-gray-600",children:[e("noAccount")," ",(0,a.jsx)(l(),{href:f?"/".concat(g,"/register?redirect=").concat(encodeURIComponent(f)):"/".concat(g,"/register"),className:"font-bold text-[var(--text-primary)] hover:text-[var(--text-hover)]",children:e("signup")})," ",e("signupLinkText")]})})]})]})})})}}},e=>{var t=t=>e(e.s=t);e.O(0,[7652,7244,6720,8441,1684,7358],()=>t(726)),_N_E=e.O()}]);